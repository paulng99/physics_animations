<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Current Balance Simulation</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Custom slider styles for better consistency */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
        }
    </style>
</head>
<body class="bg-slate-50 overflow-hidden">

<div id="canvas-container" class="w-screen h-screen block"></div>

<!-- Control Panel -->
<div class="absolute top-5 right-5 w-80 bg-white/90 backdrop-blur-md p-6 rounded-2xl shadow-xl border border-white/20 z-10">
    <div class="flex justify-between items-center mb-4 border-b border-slate-200 pb-2">
        <h2 class="text-xl font-bold text-slate-800" data-i18n="controls.title">Apparatus Controls</h2>
        <div class="flex gap-1">
             <button onclick="setLanguage('zh')" class="lang-btn px-2 py-1 rounded text-xs font-medium transition hover:bg-blue-100" data-lang="zh">繁</button>
             <button onclick="setLanguage('cn')" class="lang-btn px-2 py-1 rounded text-xs font-medium transition hover:bg-blue-100" data-lang="cn">简</button>
             <button onclick="setLanguage('en')" class="lang-btn px-2 py-1 rounded text-xs font-medium transition hover:bg-blue-100 bg-blue-600 text-white" data-lang="en">EN</button>
        </div>
    </div>
    
    <div class="mb-5">
        <div class="flex justify-between mb-1">
            <label class="text-sm font-semibold text-slate-600" data-i18n="controls.current">Current (I)</label>
            <span id="val-current" class="text-green-600 font-bold tabular-nums">1.0 A</span>
        </div>
        <input type="range" id="slider-current" min="-5" max="5" step="0.1" value="1.0" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-green-600">
    </div>

    <div class="mb-5">
        <div class="flex justify-between mb-1">
            <label class="text-sm font-semibold text-slate-600" data-i18n="controls.bfield">Magnetic Field (B)</label>
            <span id="val-bfield" class="text-amber-600 font-bold tabular-nums">0.5 T</span>
        </div>
        <input type="range" id="slider-bfield" min="0" max="2.0" step="0.1" value="0.5" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-amber-600">
    </div>

    <div class="mb-6">
        <div class="flex justify-between mb-1">
            <label class="text-sm font-semibold text-slate-600" data-i18n="controls.length">Active Length (L)</label>
            <span id="val-length" class="text-slate-600 font-bold tabular-nums">2.0 cm</span>
        </div>
        <input type="range" id="slider-length" min="1.0" max="8.0" step="0.1" value="2.0" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-slate-600">
    </div>

    <div class="bg-slate-900 rounded-xl p-4 text-white shadow-inner">
        <div class="text-[10px] uppercase tracking-wider text-slate-400 mb-1 font-bold text-center" data-i18n="balance.title">Electronic Balance</div>
        <div class="text-2xl font-mono text-green-400 text-center" id="balance-display">0.000 g</div>
        
        <div class="mt-4 pt-3 border-t border-slate-700">
            <div class="flex justify-between text-xs text-slate-300 mb-1">
                <span data-i18n="balance.force">Lorentz Force</span>
                <span id="force-val" class="text-red-400 font-bold">0.0100 N</span>
            </div>
        </div>
    </div>

    <button id="btn-explain" class="mt-4 w-full py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-xl text-sm font-semibold transition-all shadow-sm flex items-center justify-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <span data-i18n="button.explain">How it works?</span>
    </button>
</div>

<!-- Explanation Modal -->
<div id="modal-explain" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm transition-opacity duration-200">
    <div class="bg-white rounded-2xl max-w-lg w-full p-8 shadow-2xl relative">
        <button id="btn-close-explain" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
        
        <h3 class="text-2xl font-bold text-slate-800 mb-2" data-i18n="modal.title">Physics Principles</h3>
        <p class="text-slate-500 text-sm mb-6" data-i18n="modal.subtitle">Understanding the Current Balance Experiment</p>
        
        <div class="space-y-6 text-slate-600 text-sm">
            <div class="bg-blue-50 p-5 rounded-xl border border-blue-100">
                <h4 class="font-bold text-blue-800 flex items-center gap-2" data-i18n="modal.formula.title">
                    1. The Lorentz Force Formula
                </h4>
                <div class="mt-3 text-center">
                    <span class="font-mono text-lg bg-white px-4 py-2 rounded-lg shadow-sm border border-blue-100 font-bold text-slate-800">F = B × I × L</span>
                </div>
                <div class="grid grid-cols-2 gap-3 mt-4 text-xs">
                    <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-red-600"></span> <strong data-i18n="modal.legend.f">F: Magnetic Force (N)</strong></div>
                    <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-amber-600"></span> <strong data-i18n="modal.legend.b">B: Field Strength (Tesla)</strong></div>
                    <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-green-600"></span> <strong data-i18n="modal.legend.i">I: Current (Amps)</strong></div>
                    <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-slate-600"></span> <strong data-i18n="modal.legend.l">L: Active Length (m)</strong></div>
                </div>
            </div>
            
            <div class="pl-4 border-l-4 border-slate-200">
                <h4 class="font-bold text-slate-800 mb-2" data-i18n="modal.interpret.title">2. Interpreting the Result</h4>
                <p class="mb-2" data-i18n="modal.interpret.desc">The wire frame acts as a center-pivot <strong>lever</strong>.</p>
                <ul class="space-y-2">
                    <li class="flex gap-2">
                        <span class="text-green-600 font-bold">↑</span>
                        <span data-i18n="modal.interpret.up">If Magnetic Force pushes the wire end <strong>UP</strong>...</span>
                    </li>
                    <li class="flex gap-2">
                        <span class="text-red-600 font-bold">↓</span>
                        <span data-i18n="modal.interpret.down">...the lever pushes the balance end <strong>DOWN</strong>.</span>
                    </li>
                </ul>
                <div class="mt-3 text-xs bg-slate-100 p-3 rounded-lg text-center font-mono text-slate-600">
                    Balance Reading (g) = (Force / 9.81) × 1000
                </div>
            </div>
        </div>
        
        <div class="mt-6 text-center">
            <button id="btn-close-bottom" class="px-6 py-2.5 bg-slate-800 text-white rounded-xl hover:bg-slate-700 transition-colors text-sm font-semibold" data-i18n="modal.close">
                Back to Simulation
            </button>
        </div>
    </div>
</div>

<script>
    let scene, camera, renderer, frame, activeSegment, endSegment, pInsulator, forceArrow, plate;
    let northPole, southPole, yoke, rail1, rail2;
    let current = 1.0, bField = 0.5, wireLength = 2.0;
    
    const GRAVITY_CONST = 9.81;

    function init() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0xf8fafc); // Slate-50

        camera = new THREE.PerspectiveCamera(40, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(15, 12, 15);
        camera.lookAt(0, 0, 0);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        scene.add(new THREE.AmbientLight(0xffffff, 0.7));
        const sun = new THREE.DirectionalLight(0xffffff, 0.6);
        sun.position.set(10, 20, 10);
        sun.castShadow = true;
        scene.add(sun);

        // Floor
        const table = new THREE.Mesh(new THREE.PlaneGeometry(40, 40), new THREE.MeshStandardMaterial({ color: 0xe2e8f0 })); // Slate-200
        table.rotation.x = -Math.PI / 2;
        table.position.y = -3;
        table.receiveShadow = true;
        scene.add(table);
        
        const grid = new THREE.GridHelper(30, 30, 0xcbd5e1, 0xe2e8f0);
        grid.position.y = -2.99;
        scene.add(grid);

        // 1. Balance
        const balance = new THREE.Group();
        balance.add(new THREE.Mesh(new THREE.BoxGeometry(4, 1.2, 5), new THREE.MeshStandardMaterial({ color: 0x334155 })));
        plate = new THREE.Mesh(new THREE.CylinderGeometry(1.2, 1.2, 0.2, 32), new THREE.MeshStandardMaterial({ color: 0x94a3b8, metalness: 0.5 }));
        plate.position.y = 0.7;
        balance.add(plate);
        balance.position.set(6, -2.4, 0);
        scene.add(balance);

        // 2. Pivot
        const pivotMat = new THREE.MeshStandardMaterial({ color: 0x475569 });
        const p1 = new THREE.Mesh(new THREE.BoxGeometry(0.1, 3, 0.5), pivotMat);
        p1.position.set(0, -1.5, 2);
        scene.add(p1);
        const p2 = p1.clone();
        p2.position.z = -2;
        scene.add(p2);

        // 3. Magnets
        const magGroup = new THREE.Group();
        northPole = new THREE.Mesh(new THREE.BoxGeometry(2, 2, 1), new THREE.MeshStandardMaterial({ color: 0xdc2626 })); // Red-600
        southPole = new THREE.Mesh(new THREE.BoxGeometry(2, 2, 1), new THREE.MeshStandardMaterial({ color: 0x2563eb })); // Blue-600
        yoke = new THREE.Mesh(new THREE.BoxGeometry(2, 0.4, 4), new THREE.MeshStandardMaterial({ color: 0x64748b }));
        
        northPole.position.set(-6, -1, 1.5);
        southPole.position.set(-6, -1, -1.5);
        yoke.position.set(-6, -2.2, 0);
        
        magGroup.add(northPole, southPole, yoke);
        scene.add(magGroup);

        // 4. Wire Frame
        frame = new THREE.Group();
        const wireMat = new THREE.MeshStandardMaterial({ color: 0xd97706, metalness: 0.8 }); // Amber-600 (Copperish)
        const radius = 0.06;

        rail1 = new THREE.Mesh(new THREE.CylinderGeometry(radius, radius, 12, 8), wireMat);
        rail1.rotation.z = Math.PI / 2;
        rail1.position.z = 1.5;
        frame.add(rail1);

        rail2 = rail1.clone();
        rail2.position.z = -1.5;
        frame.add(rail2);

        activeSegment = new THREE.Mesh(new THREE.CylinderGeometry(radius, radius, 3, 8), wireMat);
        activeSegment.rotation.x = Math.PI / 2;
        activeSegment.position.set(-6, 0, 0);
        frame.add(activeSegment);

        endSegment = new THREE.Mesh(new THREE.CylinderGeometry(radius, radius, 3, 8), wireMat);
        endSegment.rotation.x = Math.PI / 2;
        endSegment.position.set(6, 0, 0);
        frame.add(endSegment);

        pInsulator = new THREE.Mesh(new THREE.CylinderGeometry(0.15, 0.15, 1, 16), new THREE.MeshStandardMaterial({ color: 0xffffff }));
        pInsulator.rotation.x = Math.PI / 2;
        pInsulator.position.set(6, 0, 0);
        frame.add(pInsulator);

        scene.add(frame);

        forceArrow = new THREE.ArrowHelper(new THREE.Vector3(0, 1, 0), new THREE.Vector3(-6, 0, 0), 1, 0xdc2626); // Red-600
        scene.add(forceArrow);

        setupControls();
        setupModal();
        animate();
    }

    function setupControls() {
        const update = () => {
            current = parseFloat(document.getElementById('slider-current').value);
            bField = parseFloat(document.getElementById('slider-bfield').value);
            wireLength = parseFloat(document.getElementById('slider-length').value);
            
            document.getElementById('val-current').innerText = `${current.toFixed(1)} A`;
            document.getElementById('val-bfield').innerText = `${bField.toFixed(1)} T`;
            document.getElementById('val-length').innerText = `${wireLength.toFixed(1)} cm`;
            updatePhysics();
        };
        ['slider-current', 'slider-bfield', 'slider-length'].forEach(id => document.getElementById(id).oninput = update);
        update();
    }
    
    function setupModal() {
        const modal = document.getElementById('modal-explain');
        const openBtn = document.getElementById('btn-explain');
        const closeBtns = [document.getElementById('btn-close-explain'), document.getElementById('btn-close-bottom')];
        
        const open = () => modal.classList.remove('hidden');
        const close = () => modal.classList.add('hidden');
        
        openBtn.onclick = open;
        closeBtns.forEach(btn => btn.onclick = close);
    }

    function updatePhysics() {
        const L_meters = wireLength / 100;
        const force = bField * current * L_meters;
        document.getElementById('force-val').innerText = `${Math.abs(force).toFixed(4)} N`;
        
        frame.rotation.z = force * 3.0;

        // Force Arrow
        forceArrow.visible = Math.abs(force) > 0.0005;
        if (forceArrow.visible) {
            forceArrow.setDirection(new THREE.Vector3(0, force > 0 ? 1 : -1, 0));
            forceArrow.setLength(Math.abs(force) * 200, 0.4, 0.2);
        }

        // Balance Logic
        const forceAtP = -force;
        let reading = 0;
        if (forceAtP > 0) {
            reading = (forceAtP / GRAVITY_CONST) * 1000;
            plate.position.y = 0.7 - Math.min(0.1, forceAtP * 2);
        } else {
            plate.position.y = 0.7;
        }
        document.getElementById('balance-display').innerText = `${reading.toFixed(3)} g`;

        // DYNAMIC SCALING: Wire and Magnets
        const scale = wireLength / 2.0; 
        
        // Scale wire segments
        activeSegment.scale.y = scale;
        endSegment.scale.y = scale;
        
        // Adjust rail separation
        const offset = 0.75 * scale;
        rail1.position.z = offset;
        rail2.position.z = -offset;
        activeSegment.position.z = 0;
        endSegment.position.z = 0;
        pInsulator.position.z = 0;

        // Scale magnets to match
        northPole.scale.z = scale;
        southPole.scale.z = scale;
        yoke.scale.z = scale;
        
        // Position magnets relative to wire separation
        northPole.position.z = offset + 0.5 * scale;
        southPole.position.z = -offset - 0.5 * scale;
        yoke.scale.z = (offset * 2 + 1) / 4; 
    }

    let isMouseDown = false, mouseX = 0, mouseY = 0;
    window.addEventListener('mousedown', (e) => { 
        if(e.target.tagName !== 'INPUT' && !e.target.closest('#modal-explain') && !e.target.closest('#btn-explain')) { 
            isMouseDown = true; mouseX = e.clientX; mouseY = e.clientY; 
        }
    });
    window.addEventListener('mouseup', () => isMouseDown = false);
    window.addEventListener('mousemove', (e) => {
        if (!isMouseDown) return;
        const dX = e.clientX - mouseX, dY = e.clientY - mouseY;
        const r = Math.sqrt(camera.position.x**2 + camera.position.z**2);
        const phi = Math.atan2(camera.position.z, camera.position.x) + dX * 0.01;
        camera.position.x = r * Math.cos(phi);
        camera.position.z = r * Math.sin(phi);
        camera.position.y = Math.max(1, Math.min(25, camera.position.y + dY * 0.05));
        camera.lookAt(0, 0, 0);
        mouseX = e.clientX; mouseY = e.clientY;
    });

    function animate() { requestAnimationFrame(animate); renderer.render(scene, camera); }
    window.onload = () => {
        init();
        setLanguage(currentLang);
    };

    // Language Translation System
    const translations = {
        en: {
            'controls.title': 'Apparatus Controls',
            'controls.current': 'Current (I)',
            'controls.bfield': 'Magnetic Field (B)',
            'controls.length': 'Active Length (L)',
            'balance.title': 'Electronic Balance',
            'balance.force': 'Lorentz Force',
            'button.explain': 'How it works?',
            'modal.title': 'Physics Principles',
            'modal.subtitle': 'Understanding the Current Balance Experiment',
            'modal.formula.title': '1. The Lorentz Force Formula',
            'modal.legend.f': 'F: Magnetic Force (N)',
            'modal.legend.b': 'B: Field Strength (Tesla)',
            'modal.legend.i': 'I: Current (Amps)',
            'modal.legend.l': 'L: Active Length (m)',
            'modal.interpret.title': '2. Interpreting the Result',
            'modal.interpret.desc': 'The wire frame acts as a center-pivot <strong>lever</strong>.',
            'modal.interpret.up': 'If Magnetic Force pushes the wire end <strong>UP</strong>...',
            'modal.interpret.down': '...the lever pushes the balance end <strong>DOWN</strong>.',
            'modal.close': 'Back to Simulation'
        },
        zh: {
            'controls.title': '實驗裝置控制',
            'controls.current': '電流 (I)',
            'controls.bfield': '磁場 (B)',
            'controls.length': '有效長度 (L)',
            'balance.title': '電子天平',
            'balance.force': '勞侖茲力',
            'button.explain': '原理說明',
            'modal.title': '物理原理',
            'modal.subtitle': '理解電流天平實驗',
            'modal.formula.title': '1. 勞侖茲力公式',
            'modal.legend.f': 'F: 磁力 (牛頓)',
            'modal.legend.b': 'B: 磁場強度 (特斯拉)',
            'modal.legend.i': 'I: 電流 (安培)',
            'modal.legend.l': 'L: 有效長度 (米)',
            'modal.interpret.title': '2. 解讀結果',
            'modal.interpret.desc': '線框作為一個中心支點的<strong>槓桿</strong>。',
            'modal.interpret.up': '如果磁力將線端推向<strong>上</strong>...',
            'modal.interpret.down': '...槓桿會將天平端推向<strong>下</strong>。',
            'modal.close': '返回模擬'
        },
        cn: {
            'controls.title': '实验装置控制',
            'controls.current': '电流 (I)',
            'controls.bfield': '磁场 (B)',
            'controls.length': '有效长度 (L)',
            'balance.title': '电子天平',
            'balance.force': '洛伦兹力',
            'button.explain': '原理说明',
            'modal.title': '物理原理',
            'modal.subtitle': '理解电流天平实验',
            'modal.formula.title': '1. 洛伦兹力公式',
            'modal.legend.f': 'F: 磁力 (牛顿)',
            'modal.legend.b': 'B: 磁场强度 (特斯拉)',
            'modal.legend.i': 'I: 电流 (安培)',
            'modal.legend.l': 'L: 有效长度 (米)',
            'modal.interpret.title': '2. 解读结果',
            'modal.interpret.desc': '线框作为一个中心支点的<strong>杠杆</strong>。',
            'modal.interpret.up': '如果磁力将线端推向<strong>上</strong>...',
            'modal.interpret.down': '...杠杆会将天平端推向<strong>下</strong>。',
            'modal.close': '返回模拟'
        }
    };

    let currentLang = localStorage.getItem('preferred_language') || 'en';

    function setLanguage(lang) {
        currentLang = lang;
        localStorage.setItem('preferred_language', lang);
        
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (translations[lang] && translations[lang][key]) {
                if (key.includes('interpret') || key.includes('desc')) {
                    el.innerHTML = translations[lang][key];
                } else {
                    el.textContent = translations[lang][key];
                }
            }
        });
        
        document.querySelectorAll('.lang-btn').forEach(btn => {
            if (btn.getAttribute('data-lang') === lang) {
                btn.classList.add('bg-blue-600', 'text-white');
                btn.classList.remove('text-slate-600');
            } else {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('text-slate-600');
            }
        });
        
        document.documentElement.lang = lang === 'cn' ? 'zh-CN' : lang === 'zh' ? 'zh-TW' : 'en';
    }
</script>
</body>
</html>