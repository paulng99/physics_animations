<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRO Wave Simulation: R.M.S. and Peak Values</title>
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- KaTeX for Math Rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>

    <style>
        body { margin: 0; overflow: hidden; font-family: 'Inter', sans-serif; background: #050505; }
        #canvas-container { width: 100%; height: 60vh; position: relative; }
        
        /* UI Panel Styling matching Design System */
        .ui-panel { 
            position: absolute; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            height: 40vh; 
            background: #ffffff; 
            border-top: 4px solid #2563eb; /* Brand Blue */
            display: flex; 
            padding: 24px; 
            gap: 32px; 
            overflow-y: auto; 
            color: #1f2937;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
        }
        
        .control-group { flex: 1; border-right: 1px solid #e5e7eb; padding-right: 32px; }
        .control-group:last-child { border-right: none; padding-right: 0; }
        
        .slider-label { display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: 600; color: #374151; }
        
        /* Custom Range Slider matching Brand Blue */
        input[type=range] { 
            width: 100%; 
            cursor: pointer; 
            accent-color: #2563eb; 
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
        }
        
        .math-container { 
            min-height: 70px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background: #f8fafc; /* Slate-50 */
            border-radius: 8px; 
            margin: 12px 0; 
            border: 1px solid #e2e8f0; /* Slate-200 */
            padding: 10px;
        }
        
        .legend { display: flex; gap: 16px; margin-top: 12px; font-size: 0.875rem; }
        .legend-item { display: flex; align-items: center; gap: 6px; }
        .color-box { width: 12px; height: 12px; border-radius: 2px; }
    </style>
</head>
<body>

<div class="absolute top-4 right-4 z-10 flex gap-2">
    <button onclick="setLanguage('zh')" class="lang-btn px-3 py-1 rounded-lg bg-white/10 hover:bg-white/20 text-white backdrop-blur-md border border-white/20 text-sm font-medium transition" data-lang="zh">繁</button>
    <button onclick="setLanguage('cn')" class="lang-btn px-3 py-1 rounded-lg bg-white/10 hover:bg-white/20 text-white backdrop-blur-md border border-white/20 text-sm font-medium transition" data-lang="cn">简</button>
    <button onclick="setLanguage('en')" class="lang-btn px-3 py-1 rounded-lg bg-blue-600 text-white border border-blue-500 text-sm font-medium transition shadow-lg" data-lang="en">EN</button>
</div>

<div id="canvas-container"></div>

<div class="ui-panel">
    <!-- Controls -->
    <div class="control-group">
        <h3 class="text-lg font-bold mb-3 text-gray-900 flex items-center gap-2">
            <span class="bg-blue-100 text-blue-700 w-6 h-6 rounded-full flex items-center justify-center text-xs">1</span>
            <span data-i18n="input.title">Oscilloscope Input</span>
        </h3>
        <div class="mb-6">
            <div class="slider-label">
                <span id="vp-label" data-i18n="input.vp">Peak Voltage ($V_p$):</span>
                <span id="vp-val" class="text-blue-600 font-mono text-xl">10.0 V</span>
            </div>
            <input type="range" id="vp-slider" min="1" max="20" step="0.5" value="10" aria-labelledby="vp-label vp-val">
        </div>
        <div class="legend">
            <div class="legend-item">
                <div class="color-box bg-green-500 shadow-sm"></div> <span class="text-gray-600" data-i18n="legend.peak">Peak ($V_p$)</span>
            </div>
            <div class="legend-item">
                <div class="color-box bg-blue-400 shadow-sm"></div> <span class="text-gray-600" data-i18n="legend.rms">R.M.S. Value</span>
            </div>
        </div>
        <p class="text-xs text-gray-500 italic mt-4 leading-relaxed" data-i18n="input.desc">
            The dashed blue line shows the "effective" DC equivalent voltage.
        </p>
    </div>

    <!-- Live Math Rendering -->
    <div class="control-group">
        <h3 class="text-lg font-bold mb-3 text-gray-900 flex items-center gap-2">
            <span class="bg-blue-100 text-blue-700 w-6 h-6 rounded-full flex items-center justify-center text-xs">2</span>
            <span data-i18n="math.title">Quantitative Analysis</span>
        </h3>
        <div id="math-rms" class="math-container shadow-inner"></div>
        <div id="math-pp" class="math-container shadow-inner"></div>
    </div>

    <!-- Theory Explanation -->
    <div class="control-group">
        <h3 class="text-lg font-bold mb-3 text-gray-900 flex items-center gap-2">
            <span class="bg-blue-100 text-blue-700 w-6 h-6 rounded-full flex items-center justify-center text-xs">3</span>
            <span data-i18n="visual.title">Visual Comparison</span>
        </h3>
        <div class="bg-blue-50 p-4 rounded-lg border border-blue-100 text-blue-900 text-sm leading-relaxed">
            <p class="mb-2" data-i18n="visual.desc1">
                Notice that the <strong>Blue R.M.S. line</strong> sits at approximately 70.7% of the total height of the <strong>Green Peak</strong>.
            </p>
            <p data-i18n="visual.desc2">
                Even though the voltage reaches the peak, the "average" power delivered is equivalent to the steady blue line level.
            </p>
        </div>
    </div>
</div>

<script>
    let scene, camera, renderer, waveLine, rmsLine, gridGroup;
    let peakVoltage = 10.0;
    const scale = 0.4; // 1 unit = 2.5V roughly for grid scaling

    function init() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0a1a0a); // Dark Green/Black for CRO feel

        camera = new THREE.PerspectiveCamera(45, window.innerWidth / (window.innerHeight * 0.6), 0.1, 1000);
        camera.position.set(0, 0, 12);
        camera.lookAt(0, 0, 0);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight * 0.6);
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        createScreen();
        setupInteraction();
        updateUI();
        animate();
    }

    function createScreen() {
        gridGroup = new THREE.Group();
        scene.add(gridGroup);

        // Grid lines
        const gridMaterial = new THREE.LineBasicMaterial({ color: 0x004400, transparent: true, opacity: 0.3 });
        for (let i = -10; i <= 10; i++) {
            const vPoints = [new THREE.Vector3(i, -6, 0), new THREE.Vector3(i, 6, 0)];
            const vGeo = new THREE.BufferGeometry().setFromPoints(vPoints);
            gridGroup.add(new THREE.Line(vGeo, gridMaterial));

            const hPoints = [new THREE.Vector3(-10, i, 0), new THREE.Vector3(10, i, 0)];
            const hGeo = new THREE.BufferGeometry().setFromPoints(hPoints);
            gridGroup.add(new THREE.Line(hGeo, gridMaterial));
        }

        // Axes
        const axisMaterial = new THREE.LineBasicMaterial({ color: 0x00ff00, transparent: true, opacity: 0.5 });
        const xPoints = [new THREE.Vector3(-10, 0, 0), new THREE.Vector3(10, 0, 0)];
        gridGroup.add(new THREE.Line(new THREE.BufferGeometry().setFromPoints(xPoints), axisMaterial));
        const yPoints = [new THREE.Vector3(0, -6, 0), new THREE.Vector3(0, 6, 0)];
        gridGroup.add(new THREE.Line(new THREE.BufferGeometry().setFromPoints(yPoints), axisMaterial));

        // Waveform
        const wavePoints = [];
        for(let i=0; i<=200; i++) wavePoints.push(new THREE.Vector3((i/200)*20-10, 0, 0.1));
        const waveGeo = new THREE.BufferGeometry().setFromPoints(wavePoints);
        waveLine = new THREE.Line(waveGeo, new THREE.LineBasicMaterial({ color: 0x00ff00, linewidth: 2 }));
        scene.add(waveLine);

        // RMS Indicator Line (Dashed-style implementation)
        const rmsPoints = [new THREE.Vector3(-10, 0, 0.2), new THREE.Vector3(10, 0, 0.2)];
        const rmsGeo = new THREE.BufferGeometry().setFromPoints(rmsPoints);
        rmsLine = new THREE.LineSegments(rmsGeo, new THREE.LineDashedMaterial({ 
            color: 0x60a5fa, // Blue-400
            dashSize: 0.5, 
            gapSize: 0.2 
        }));
        rmsLine.computeLineDistances();
        scene.add(rmsLine);
    }

    function renderMath() {
        const vrms = peakVoltage / Math.SQRT2;
        const vpp = peakVoltage * 2;
        const textVpp = typeof t === 'function' ? t('math.vpp_text') : 'V (Peak-to-Peak)';

        katex.render(
            `V_{rms} = \\frac{V_p}{\\sqrt{2}} = \\frac{${peakVoltage.toFixed(1)}}{\\sqrt{2}} \\approx \\color{#60a5fa}{${vrms.toFixed(2)}\\text{ V}}`,
            document.getElementById('math-rms'),
            { throwOnError: false, displayMode: true }
        );

        katex.render(
            `V_{pp} = 2 \\times V_p = ${vpp.toFixed(1)}\\text{ ${textVpp}}`,
            document.getElementById('math-pp'),
            { throwOnError: false, displayMode: true }
        );
    }

    function setupInteraction() {
        const slider = document.getElementById('vp-slider');
        slider.addEventListener('input', (e) => {
            peakVoltage = parseFloat(e.target.value);
            updateUI();
        });

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / (window.innerHeight * 0.6);
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight * 0.6);
        });
    }

    function updateUI() {
        document.getElementById('vp-val').innerText = peakVoltage.toFixed(1) + " V";
        
        // Update RMS line position
        const vrmsValue = peakVoltage / Math.SQRT2;
        rmsLine.position.y = vrmsValue * scale;
        
        renderMath();
    }

    function animate() {
        requestAnimationFrame(animate);
        
        const pos = waveLine.geometry.attributes.position.array;
        const t_time = Date.now() * 0.004;

        for(let i=0; i<=200; i++) {
            pos[i*3 + 1] = Math.sin(i*0.1 - t_time) * (peakVoltage * scale);
        }
        waveLine.geometry.attributes.position.needsUpdate = true;
        
        renderer.render(scene, camera);
    }

    window.onload = () => {
        init();
        setLanguage(currentLang);
    };

    // Language Translation System
    const translations = {
        en: {
            'input.title': 'Oscilloscope Input',
            'input.vp': 'Peak Voltage ($V_p$):',
            'legend.peak': 'Peak ($V_p$)',
            'legend.rms': 'R.M.S. Value',
            'input.desc': 'The dashed blue line shows the "effective" DC equivalent voltage.',
            'math.title': 'Quantitative Analysis',
            'math.vpp_text': 'V (Peak-to-Peak)',
            'visual.title': 'Visual Comparison',
            'visual.desc1': 'Notice that the <strong>Blue R.M.S. line</strong> sits at approximately 70.7% of the total height of the <strong>Green Peak</strong>.',
            'visual.desc2': 'Even though the voltage reaches the peak, the "average" power delivered is equivalent to the steady blue line level.'
        },
        zh: {
            'input.title': '示波器輸入',
            'input.vp': '峰值電壓 ($V_p$):',
            'legend.peak': '峰值 ($V_p$)',
            'legend.rms': '均方根值 (R.M.S.)',
            'input.desc': '藍色虛線顯示"有效"的直流等效電壓。',
            'math.title': '定量分析',
            'math.vpp_text': 'V (峰對峰值)',
            'visual.title': '視覺比較',
            'visual.desc1': '注意<strong>藍色 R.M.S. 線</strong>位於<strong>綠色峰值</strong>高度的約 70.7% 處。',
            'visual.desc2': '即使電壓達到峰值，傳遞的"平均"功率相當於穩定的藍色線水平。'
        },
        cn: {
            'input.title': '示波器输入',
            'input.vp': '峰值电压 ($V_p$):',
            'legend.peak': '峰值 ($V_p$)',
            'legend.rms': '均方根值 (R.M.S.)',
            'input.desc': '蓝色虚线显示"有效"的直流等效电压。',
            'math.title': '定量分析',
            'math.vpp_text': 'V (峰对峰值)',
            'visual.title': '视觉比较',
            'visual.desc1': '注意<strong>蓝色 R.M.S. 线</strong>位于<strong>绿色峰值</strong>高度的约 70.7% 处。',
            'visual.desc2': '即使电压达到峰值，传递的"平均"功率相当于稳定的蓝色线水平。'
        }
    };

    let currentLang = localStorage.getItem('preferred_language') || 'en';

    function t(key) {
        return (translations[currentLang] && translations[currentLang][key]) || key;
    }

    function setLanguage(lang) {
        currentLang = lang;
        localStorage.setItem('preferred_language', lang);
        
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (translations[lang] && translations[lang][key]) {
                if (key.includes('desc')) {
                    el.innerHTML = translations[lang][key];
                } else {
                    el.textContent = translations[lang][key];
                }
            }
        });
        
        document.querySelectorAll('.lang-btn').forEach(btn => {
            if (btn.getAttribute('data-lang') === lang) {
                btn.classList.add('bg-blue-600', 'border-blue-500');
                btn.classList.remove('bg-white/10', 'border-white/20');
            } else {
                btn.classList.remove('bg-blue-600', 'border-blue-500');
                btn.classList.add('bg-white/10', 'border-white/20');
            }
        });
        
        document.documentElement.lang = lang === 'cn' ? 'zh-CN' : lang === 'zh' ? 'zh-TW' : 'en';
        
        // Re-render math to update language inside KaTeX
        renderMath();
    }
</script>
</body>
</html>