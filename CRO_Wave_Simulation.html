<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRO Wave Simulation: R.M.S. and Peak Values</title>
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- KaTeX for Math Rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>

    <style>
        body { margin: 0; overflow: hidden; font-family: 'Inter', sans-serif; background: #050505; }
        #canvas-container { width: 100%; height: 60vh; position: relative; }
        
        /* UI Panel Styling matching Design System */
        .ui-panel { 
            position: absolute; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            height: 40vh; 
            background: #ffffff; 
            border-top: 4px solid #2563eb; /* Brand Blue */
            display: flex; 
            padding: 24px; 
            gap: 32px; 
            overflow-y: auto; 
            color: #1f2937;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
        }
        
        .control-group { flex: 1; border-right: 1px solid #e5e7eb; padding-right: 32px; }
        .control-group:last-child { border-right: none; padding-right: 0; }
        
        .slider-label { display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: 600; color: #374151; }
        
        /* Custom Range Slider matching Brand Blue */
        input[type=range] { 
            width: 100%; 
            cursor: pointer; 
            accent-color: #2563eb; 
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
        }
        
        .math-container { 
            min-height: 70px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background: #f8fafc; /* Slate-50 */
            border-radius: 8px; 
            margin: 12px 0; 
            border: 1px solid #e2e8f0; /* Slate-200 */
            padding: 10px;
        }
        
        .legend { display: flex; gap: 16px; margin-top: 12px; font-size: 0.875rem; }
        .legend-item { display: flex; align-items: center; gap: 6px; }
        .color-box { width: 12px; height: 12px; border-radius: 2px; }
    </style>
</head>
<body>

<div id="canvas-container"></div>

<div class="ui-panel">
    <!-- Controls -->
    <div class="control-group">
        <h3 class="text-lg font-bold mb-3 text-gray-900 flex items-center gap-2">
            <span class="bg-blue-100 text-blue-700 w-6 h-6 rounded-full flex items-center justify-center text-xs">1</span>
            Oscilloscope Input
        </h3>
        <div class="mb-6">
            <div class="slider-label">
                <span id="vp-label">Peak Voltage ($V_p$):</span>
                <span id="vp-val" class="text-blue-600 font-mono text-xl">10.0 V</span>
            </div>
            <input type="range" id="vp-slider" min="1" max="20" step="0.5" value="10" aria-labelledby="vp-label vp-val">
        </div>
        <div class="legend">
            <div class="legend-item">
                <div class="color-box bg-green-500 shadow-sm"></div> <span class="text-gray-600">Peak ($V_p$)</span>
            </div>
            <div class="legend-item">
                <div class="color-box bg-blue-400 shadow-sm"></div> <span class="text-gray-600">R.M.S. Value</span>
            </div>
        </div>
        <p class="text-xs text-gray-500 italic mt-4 leading-relaxed">
            The dashed blue line shows the "effective" DC equivalent voltage.
        </p>
    </div>

    <!-- Live Math Rendering -->
    <div class="control-group">
        <h3 class="text-lg font-bold mb-3 text-gray-900 flex items-center gap-2">
            <span class="bg-blue-100 text-blue-700 w-6 h-6 rounded-full flex items-center justify-center text-xs">2</span>
            Quantitative Analysis
        </h3>
        <div id="math-rms" class="math-container shadow-inner"></div>
        <div id="math-pp" class="math-container shadow-inner"></div>
    </div>

    <!-- Theory Explanation -->
    <div class="control-group">
        <h3 class="text-lg font-bold mb-3 text-gray-900 flex items-center gap-2">
            <span class="bg-blue-100 text-blue-700 w-6 h-6 rounded-full flex items-center justify-center text-xs">3</span>
            Visual Comparison
        </h3>
        <div class="bg-blue-50 p-4 rounded-lg border border-blue-100 text-blue-900 text-sm leading-relaxed">
            <p class="mb-2">
                Notice that the <strong>Blue R.M.S. line</strong> sits at approximately 70.7% of the total height of the <strong>Green Peak</strong>.
            </p>
            <p>
                Even though the voltage reaches the peak, the "average" power delivered is equivalent to the steady blue line level.
            </p>
        </div>
    </div>
</div>

<script>
    let scene, camera, renderer, waveLine, rmsLine, gridGroup;
    let peakVoltage = 10.0;
    const scale = 0.4; // 1 unit = 2.5V roughly for grid scaling

    function init() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0a1a0a); // Dark Green/Black for CRO feel

        camera = new THREE.PerspectiveCamera(45, window.innerWidth / (window.innerHeight * 0.6), 0.1, 1000);
        camera.position.set(0, 0, 12);
        camera.lookAt(0, 0, 0);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight * 0.6);
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        createScreen();
        setupInteraction();
        updateUI();
        animate();
    }

    function createScreen() {
        gridGroup = new THREE.Group();
        scene.add(gridGroup);

        // Grid lines
        const gridMaterial = new THREE.LineBasicMaterial({ color: 0x004400, transparent: true, opacity: 0.3 });
        for (let i = -10; i <= 10; i++) {
            const vPoints = [new THREE.Vector3(i, -6, 0), new THREE.Vector3(i, 6, 0)];
            const vGeo = new THREE.BufferGeometry().setFromPoints(vPoints);
            gridGroup.add(new THREE.Line(vGeo, gridMaterial));

            const hPoints = [new THREE.Vector3(-10, i, 0), new THREE.Vector3(10, i, 0)];
            const hGeo = new THREE.BufferGeometry().setFromPoints(hPoints);
            gridGroup.add(new THREE.Line(hGeo, gridMaterial));
        }

        // Axes
        const axisMaterial = new THREE.LineBasicMaterial({ color: 0x00ff00, transparent: true, opacity: 0.5 });
        const xPoints = [new THREE.Vector3(-10, 0, 0), new THREE.Vector3(10, 0, 0)];
        gridGroup.add(new THREE.Line(new THREE.BufferGeometry().setFromPoints(xPoints), axisMaterial));
        const yPoints = [new THREE.Vector3(0, -6, 0), new THREE.Vector3(0, 6, 0)];
        gridGroup.add(new THREE.Line(new THREE.BufferGeometry().setFromPoints(yPoints), axisMaterial));

        // Waveform
        const wavePoints = [];
        for(let i=0; i<=200; i++) wavePoints.push(new THREE.Vector3((i/200)*20-10, 0, 0.1));
        const waveGeo = new THREE.BufferGeometry().setFromPoints(wavePoints);
        waveLine = new THREE.Line(waveGeo, new THREE.LineBasicMaterial({ color: 0x00ff00, linewidth: 2 }));
        scene.add(waveLine);

        // RMS Indicator Line (Dashed-style implementation)
        const rmsPoints = [new THREE.Vector3(-10, 0, 0.2), new THREE.Vector3(10, 0, 0.2)];
        const rmsGeo = new THREE.BufferGeometry().setFromPoints(rmsPoints);
        rmsLine = new THREE.LineSegments(rmsGeo, new THREE.LineDashedMaterial({ 
            color: 0x60a5fa, // Blue-400
            dashSize: 0.5, 
            gapSize: 0.2 
        }));
        rmsLine.computeLineDistances();
        scene.add(rmsLine);
    }

    function renderMath() {
        const vrms = peakVoltage / Math.SQRT2;
        const vpp = peakVoltage * 2;

        katex.render(
            `V_{rms} = \\frac{V_p}{\\sqrt{2}} = \\frac{${peakVoltage.toFixed(1)}}{\\sqrt{2}} \\approx \\color{#60a5fa}{${vrms.toFixed(2)}\\text{ V}}`,
            document.getElementById('math-rms'),
            { throwOnError: false, displayMode: true }
        );

        katex.render(
            `V_{pp} = 2 \\times V_p = ${vpp.toFixed(1)}\\text{ V (Peak-to-Peak)}`,
            document.getElementById('math-pp'),
            { throwOnError: false, displayMode: true }
        );
    }

    function setupInteraction() {
        const slider = document.getElementById('vp-slider');
        slider.addEventListener('input', (e) => {
            peakVoltage = parseFloat(e.target.value);
            updateUI();
        });

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / (window.innerHeight * 0.6);
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight * 0.6);
        });
    }

    function updateUI() {
        document.getElementById('vp-val').innerText = peakVoltage.toFixed(1) + " V";
        
        // Update RMS line position
        const vrmsValue = peakVoltage / Math.SQRT2;
        rmsLine.position.y = vrmsValue * scale;
        
        renderMath();
    }

    function animate() {
        requestAnimationFrame(animate);
        
        const pos = waveLine.geometry.attributes.position.array;
        const t = Date.now() * 0.004;

        for(let i=0; i<=200; i++) {
            pos[i*3 + 1] = Math.sin(i*0.1 - t) * (peakVoltage * scale);
        }
        waveLine.geometry.attributes.position.needsUpdate = true;
        
        renderer.render(scene, camera);
    }

    window.onload = init;
</script>
</body>
</html>